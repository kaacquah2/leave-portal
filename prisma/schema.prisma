// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  role          String   // Ghana Government roles: 'employee' | 'supervisor' | 'unit_head' | 'division_head' | 'directorate_head' | 'regional_manager' | 'hr_officer' | 'hr_director' | 'chief_director' | 'internal_auditor' | 'admin' | Legacy: 'hr' | 'hr_assistant' | 'manager' | 'deputy_director'
  staffId       String?  @unique
  active        Boolean  @default(true)
  emailVerified Boolean  @default(false)
  lastLogin     DateTime?
  // Security enhancements
  passwordChangedAt DateTime? // Track password change date
  passwordExpiresAt DateTime? // Password expiration date
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret String?  // TOTP secret
  twoFactorBackupCodes String[] // Backup codes
  sessionTimeout Int @default(1800) // Session timeout in seconds (default 30 minutes)
  failedLoginAttempts Int @default(0)
  lockedUntil DateTime? // Account lock until this date
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  staff         StaffMember? @relation(fields: [staffId], references: [staffId])
  sessions      Session[]
  notifications Notification[]
  passwordResetTokens PasswordResetToken[]
  passwordResetRequests PasswordResetRequest[]
  pushSubscription PushSubscription?
  privacyAcknowledgement PrivacyAcknowledgement?
  passwordHistory PasswordHistory[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ip        String?
  userAgent String?
  lastActivity DateTime @default(now()) // Track last activity for timeout
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, expiresAt])
  @@index([lastActivity])
}

model StaffMember {
  id               String   @id @default(cuid())
  staffId          String   @unique
  firstName        String
  lastName         String
  email            String   @unique
  phone            String
  department       String
  position         String
  grade            String
  level            String
  // Government HR metadata
  rank             String?  // Staff rank (e.g., "Senior Officer", "Principal Officer")
  step             String?  // Step within grade
  directorate      String?  // Directorate name (e.g., "Finance & Administration Directorate", "Policy, Planning, Monitoring & Evaluation (PPME) Directorate", null = reports to Chief Director)
  division         String?  // Division within directorate (MoFA structure - not commonly used)
  unit             String?  // Unit name (e.g., "Human Resource Management Unit (HRMU)", "Accounts Unit", "Protocol Unit", "Internal Audit Unit", etc.)
  dutyStation      String?  // 'HQ' | 'Region' | 'District' | 'Agency' (e.g., Fisheries Commission)
  photoUrl         String?
  active           Boolean  @default(true)
  employmentStatus String   @default("active") // 'active' | 'terminated' | 'resigned' | 'retired' | 'suspended'
  terminationDate DateTime?
  terminationReason String?
  joinDate         DateTime
  managerId        String?  // Staff ID of the manager (for team assignment)
  immediateSupervisorId String? // Staff ID of immediate supervisor/line manager
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user              User?
  manager           StaffMember? @relation("TeamMembers", fields: [managerId], references: [staffId])
  teamMembers       StaffMember[] @relation("TeamMembers")
  leaveRequests     LeaveRequest[]
  leaveBalance      LeaveBalance?
  payslips          Payslip[]
  performanceReviews PerformanceReview[]
  attendances      Attendance[]
  timesheets        Timesheet[]
  disciplinaryActions DisciplinaryAction[]
  documents         Document[]
  salaryStructures  SalaryStructure[]
  trainings         TrainingAttendance[]
  onboardingChecklist OnboardingChecklist?
  offboardingChecklist OffboardingChecklist?
  changeRequests    ProfileChangeRequest[]
  delegations       ApprovalDelegation[] @relation("Delegator") // As delegator
  delegatedTo       ApprovalDelegation[] @relation("Delegatee") // As delegatee
  balanceOverrides  LeaveBalanceOverride[]
}

model LeaveRequest {
  id            String   @id @default(cuid())
  staffId       String
  staffName     String
  leaveType     String   // 'Annual' | 'Sick' | 'Unpaid' | 'Special Service' | 'Training' | 'Study' | 'Maternity' | 'Paternity' | 'Compassionate'
  startDate     DateTime
  endDate       DateTime
  days          Int
  reason        String
  status        String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'cancelled'
  approvedBy    String?
  approvalDate  DateTime?
  templateId    String?
  approvalLevels Json?   // Array of LeaveApprovalLevel
  // Government HR: Attachments support
  attachments   LeaveAttachment[]
  // MoFA Compliance: Handover and declaration fields
  officerTakingOver String? // Name/Staff ID of officer taking over duties
  handoverNotes     String? // Handover notes/instructions
  declarationAccepted Boolean @default(false) // "I will not proceed on leave without approval"
  // Payroll impact tracking
  payrollImpactFlag Boolean @default(false) // Flag for unpaid leave or special payroll considerations
  locked          Boolean @default(false) // Lock approved records from editing
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
  template LeaveRequestTemplate? @relation(fields: [templateId], references: [id])
  approvalHistory LeaveApprovalHistory[]
  approvalSteps ApprovalStep[] @relation("ApprovalSteps")
}

model LeaveBalance {
  id             String   @id @default(cuid())
  staffId        String   @unique
  annual         Float    @default(0)
  sick           Float    @default(0)
  unpaid         Float    @default(0)
  specialService Float    @default(0)
  training       Float    @default(0)
  study          Float    @default(0)
  maternity      Float    @default(0)
  paternity      Float    @default(0)
  compassionate  Float    @default(0)
  
  // Accrual tracking
  lastAccrualDate DateTime? // Last date when accrual was processed
  accrualPeriod   String?    // 'monthly' | 'annual' | 'quarterly'
  
  // Carry-forward tracking (for each leave type)
  annualCarryForward         Float @default(0)
  sickCarryForward           Float @default(0)
  specialServiceCarryForward Float @default(0)
  trainingCarryForward       Float @default(0)
  studyCarryForward          Float @default(0)
  
  // Expiration tracking
  annualExpiresAt         DateTime? // When unused annual leave expires
  sickExpiresAt           DateTime? // When unused sick leave expires (if applicable)
  specialServiceExpiresAt DateTime?
  trainingExpiresAt       DateTime?
  studyExpiresAt          DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  staff          StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
  accrualHistory LeaveAccrualHistory[]
  
  @@index([lastAccrualDate])
  @@index([annualExpiresAt])
}

model LeaveAccrualHistory {
  id              String   @id @default(cuid())
  staffId         String
  leaveType       String   // 'Annual' | 'Sick' | 'Special Service' | 'Training' | 'Study'
  accrualDate     DateTime @default(now())
  accrualPeriod   String   // 'monthly' | 'annual' | 'quarterly' | 'pro-rata' | 'carry-forward' | 'expiration'
  daysAccrued     Float    // Days added (positive) or removed (negative)
  daysBefore      Float    // Balance before accrual
  daysAfter       Float    // Balance after accrual
  proRataFactor   Float?   // Pro-rata calculation factor (e.g., 0.5 for half month)
  carryForwardDays Float?  // Days carried forward (if applicable)
  expiredDays     Float?   // Days expired (if applicable)
  notes           String?  // Additional notes about the accrual
  processedBy     String?  // User/system that processed the accrual
  createdAt       DateTime @default(now())

  // Relations
  balance LeaveBalance @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@index([staffId, accrualDate])
  @@index([accrualDate])
  @@index([leaveType])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // Action type: 'leave_submitted' | 'leave_approved' | 'leave_rejected' | 'balance_deducted' | 'balance_restored' | 'user_login' | 'user_logout' | 'role_changed' | etc.
  user      String   // User ID or email
  userRole  String?  // Role of user performing action (for compliance)
  staffId   String?  // Related staff ID (if applicable)
  leaveRequestId String? // Related leave request ID (if applicable)
  details   String   // Detailed description of action
  metadata  Json?    // Additional structured data (approval level, comments, etc.)
  timestamp DateTime @default(now())
  ip        String?  // IP address for security tracking
  userAgent String?  // User agent for security tracking
  
  @@index([action, timestamp])
  @@index([user, timestamp])
  @@index([staffId, timestamp])
  @@index([leaveRequestId, timestamp])
  @@index([userRole, timestamp])
}

// MoFA Compliance: Leave Approval History (immutable audit trail)
model LeaveApprovalHistory {
  id            String   @id @default(cuid())
  leaveRequestId String
  level         Int      // Approval level number
  action        String   // 'submitted' | 'approved' | 'rejected' | 'delegated' | 'recalled'
  approverId    String   // User ID of approver
  approverName  String   // Name of approver
  approverRole  String   // Role of approver (MoFA role code)
  approverStaffId String? // Staff ID of approver (if applicable)
  comments      String?  // Approval/rejection comments
  previousStatus String? // Previous status
  newStatus     String?  // New status after this action
  delegatedTo   String?  // If delegated, who it was delegated to
  timestamp     DateTime @default(now())
  ip            String?  // IP address
  userAgent     String?  // User agent
  
  // Relations
  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)
  
  @@index([leaveRequestId, level])
  @@index([approverId, timestamp])
  @@index([timestamp])
}

// MoFA Compliance: Approval Steps (tracks current state of each approval level)
model ApprovalStep {
  id            String   @id @default(cuid())
  leaveRequestId String
  level         Int      // Sequential approval level (1, 2, 3, ...)
  approverRole  String   // MoFA role code required for this step
  approverStaffId String? // Specific staff ID assigned (if known)
  approverUserId String?  // User ID of approver (when assigned)
  status        String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'delegated' | 'skipped'
  approverName  String?  // Name of approver (when approved/rejected)
  approvalDate  DateTime? // When approved/rejected
  comments      String?  // Approval/rejection comments
  delegatedTo   String?  // User ID if delegated
  delegatedToName String? // Name of delegate
  delegationDate DateTime? // When delegated
  previousLevelCompleted Boolean @default(false) // Whether previous level is complete
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  leaveRequest LeaveRequest @relation("ApprovalSteps", fields: [leaveRequestId], references: [id], onDelete: Cascade)
  
  @@unique([leaveRequestId, level])
  @@index([leaveRequestId, status])
  @@index([approverRole, status])
  @@index([approverStaffId, status])
  @@index([status, createdAt])
}

model Payslip {
  id          String   @id @default(cuid())
  staffId     String
  month       String   // YYYY-MM format
  year        Int
  basicSalary Float
  allowances  Float
  deductions  Float
  netSalary   Float
  tax         Float
  pension     Float
  pdfUrl      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
}

model PerformanceReview {
  id                   String   @id @default(cuid())
  staffId              String
  reviewPeriod         String   // e.g., "2024 Q1"
  reviewDate           DateTime
  reviewedBy           String
  rating               Int      // 1-5
  strengths            String[] // Array of strings
  areasForImprovement  String[] // Array of strings
  goals                String[] // Array of strings
  comments             String
  status               String   @default("draft") // 'draft' | 'completed'
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
}

model LeavePolicy {
  id              String   @id @default(cuid())
  leaveType       String   // 'Annual' | 'Sick' | 'Unpaid' | 'Special Service' | 'Training' | 'Study' | 'Maternity' | 'Paternity' | 'Compassionate'
  maxDays         Int
  accrualRate     Float    // days per month
  accrualFrequency String  @default("monthly") // 'monthly' | 'annual' | 'quarterly'
  carryoverAllowed Boolean  @default(false)
  maxCarryover    Int      @default(0)
  expiresAfterMonths Int?  // Number of months after which unused leave expires (null = never expires)
  requiresApproval Boolean  @default(true)
  approvalLevels  Int      @default(1) // 1 = manager, 2 = manager + HR
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Holiday {
  id        String   @id @default(cuid())
  name      String
  date      DateTime
  type      String   // 'public' | 'company' | 'regional'
  recurring Boolean  @default(false)
  year      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LeaveRequestTemplate {
  id           String   @id @default(cuid())
  name         String
  leaveType    String   // 'Annual' | 'Sick' | 'Unpaid' | 'Special Service' | 'Training' | 'Study' | 'Maternity' | 'Paternity' | 'Compassionate'
  defaultDays  Int
  defaultReason String
  department   String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  leaveRequests LeaveRequest[]
}

model Attendance {
  id            String   @id @default(cuid())
  staffId       String
  date          DateTime
  clockIn       DateTime?
  clockOut      DateTime?
  breakDuration Int?     // in minutes
  totalHours    Float?
  status        String   // 'present' | 'absent' | 'late' | 'half-day' | 'on-leave'
  notes         String?
  correctedBy  String?
  correctionReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@unique([staffId, date])
  @@index([staffId, date])
}

model AttendanceCorrection {
  id          String   @id @default(cuid())
  attendanceId String
  staffId     String
  requestDate DateTime @default(now())
  correctionDate DateTime
  reason      String
  status      String   @default("pending") // 'pending' | 'approved' | 'rejected'
  reviewedBy String?
  reviewedAt DateTime?
  comments   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([staffId, status])
}

model Timesheet {
  id          String   @id @default(cuid())
  staffId     String
  weekStart   DateTime
  weekEnd     DateTime
  hours       Json     // Array of daily hours: [{date, hours, project, task}]
  totalHours  Float
  status      String   @default("draft") // 'draft' | 'submitted' | 'approved' | 'rejected'
  submittedAt DateTime?
  approvedBy  String?
  approvedAt  DateTime?
  rejectedBy String?
  rejectedAt DateTime?
  comments    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@unique([staffId, weekStart])
  @@index([staffId, status])
}

model DisciplinaryAction {
  id          String   @id @default(cuid())
  staffId     String
  actionType  String   // 'verbal_warning' | 'written_warning' | 'suspension' | 'termination'
  severity    String   // 'low' | 'medium' | 'high' | 'critical'
  title       String
  description String
  incidentDate DateTime
  issuedBy    String
  issuedDate  DateTime @default(now())
  documentUrl String?
  status      String   @default("active") // 'active' | 'resolved' | 'expired'
  resolvedDate DateTime?
  resolvedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@index([staffId, status])
  @@index([actionType, status])
}

model Document {
  id              String   @id @default(cuid())
  staffId         String?
  name            String
  type            String   // 'contract' | 'certificate' | 'warning' | 'promotion' | 'other'
  category        String
  fileUrl         String
  fileSize        Int
  mimeType        String
  uploadedBy      String
  uploadedAt      DateTime @default(now())
  description     String?
  isPublic        Boolean  @default(false)
  expiresAt       DateTime?
  
  // Enhanced features
  version         Int      @default(1) // Document version number
  parentId        String?  // Reference to parent document (for versioning)
  tags            String[] // Array of tags for categorization
  searchText      String?  // Full-text search field (name + description + tags)
  templateId      String?  // Reference to document template if created from template
  signedBy        String?  // User who digitally signed
  signedAt        DateTime? // When document was signed
  signatureHash   String?  // Hash of digital signature for verification
  status          String   @default("active") // 'active' | 'archived' | 'expired' | 'deleted'
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  staff           StaffMember? @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
  parent          Document?    @relation("DocumentVersions", fields: [parentId], references: [id])
  versions        Document[]   @relation("DocumentVersions")
  template        DocumentTemplate? @relation(fields: [templateId], references: [id])

  @@index([staffId, type])
  @@index([type, category])
  @@index([parentId])
  @@index([templateId])
  @@index([status, expiresAt])
  @@index([tags]) // PostgreSQL supports array indexing
}

model DocumentTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  type        String   // Document type this template is for
  fileUrl     String?  // Template file URL (optional)
  fields      Json?    // Template fields structure (JSON)
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  documents   Document[]

  @@index([category, type])
  @@index([isActive])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String?
  staffId     String?
  type        String   // 'leave_approved' | 'leave_rejected' | 'timesheet_approved' | 'attendance_correction' | 'system'
  title       String
  message     String
  link        String?
  read        Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([staffId, read])
}

model JobPosting {
  id          String   @id @default(cuid())
  title       String
  department  String
  position    String
  description String
  requirements String
  status      String   @default("draft") // 'draft' | 'published' | 'closed' | 'filled'
  postedBy    String
  postedDate  DateTime @default(now())
  closingDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  candidates Candidate[]

  @@index([status, department])
}

model Candidate {
  id            String   @id @default(cuid())
  jobPostingId String
  firstName    String
  lastName     String
  email        String
  phone        String
  resumeUrl    String?
  coverLetter  String?
  status       String   @default("applied") // 'applied' | 'screening' | 'interview' | 'offered' | 'rejected' | 'hired'
  appliedDate  DateTime @default(now())
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  jobPosting JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@index([jobPostingId, status])
}

model Interview {
  id          String   @id @default(cuid())
  candidateId String
  scheduledDate DateTime
  interviewType String // 'phone' | 'video' | 'in-person'
  interviewers String[] // Array of interviewer names/IDs
  location    String?
  notes       String?
  rating      Int?     // 1-5
  status      String   @default("scheduled") // 'scheduled' | 'completed' | 'cancelled' | 'rescheduled'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId, status])
}

model SalaryStructure {
  id          String   @id @default(cuid())
  staffId     String   @unique
  basicSalary Float
  allowances  Json?    // {housing: 0, transport: 0, medical: 0, etc.}
  deductions  Json?    // {tax: 0, pension: 0, loan: 0, etc.}
  effectiveDate DateTime
  endDate     DateTime?
  approvedBy  String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@index([staffId, effectiveDate])
}

model Payroll {
  id          String   @id @default(cuid())
  period      String   // YYYY-MM format
  month       Int
  year        Int
  totalStaff  Int
  totalAmount Float
  status      String   @default("draft") // 'draft' | 'processing' | 'approved' | 'paid'
  processedBy String?
  processedAt DateTime?
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([period])
  @@index([year, month, status])
}

model TrainingProgram {
  id          String   @id @default(cuid())
  title       String
  description String
  provider    String
  type        String   // 'internal' | 'external' | 'online'
  startDate   DateTime
  endDate     DateTime
  location    String?
  capacity    Int?
  status      String   @default("scheduled") // 'scheduled' | 'ongoing' | 'completed' | 'cancelled'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  attendees TrainingAttendance[]

  @@index([status, startDate])
}

model TrainingAttendance {
  id              String   @id @default(cuid())
  trainingProgramId String
  staffId         String
  status          String   @default("registered") // 'registered' | 'attended' | 'completed' | 'absent'
  certificateUrl String?
  rating          Int?     // 1-5
  feedback        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  trainingProgram TrainingProgram @relation(fields: [trainingProgramId], references: [id], onDelete: Cascade)
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@unique([trainingProgramId, staffId])
  @@index([staffId, status])
}

model OnboardingChecklist {
  id          String   @id @default(cuid())
  staffId     String   @unique
  items       Json     // Array of {task, completed, completedBy, completedAt}
  status      String   @default("pending") // 'pending' | 'in-progress' | 'completed'
  startedDate DateTime @default(now())
  completedDate DateTime?
  assignedTo String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
}

model OffboardingChecklist {
  id          String   @id @default(cuid())
  staffId     String   @unique
  items       Json     // Array of {task, completed, completedBy, completedAt}
  status      String   @default("pending") // 'pending' | 'in-progress' | 'completed'
  startedDate DateTime @default(now())
  completedDate DateTime?
  exitInterviewCompleted Boolean @default(false)
  exitInterviewNotes String?
  assignedTo String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   // 'string' | 'number' | 'boolean' | 'json'
  category    String   // 'general' | 'email' | 'leave' | 'attendance' | 'payroll'
  description String?
  updatedBy   String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model PasswordResetRequest {
  id        String   @id @default(cuid())
  userId    String
  email     String
  status    String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'completed'
  requestedAt DateTime @default(now())
  approvedAt DateTime?
  approvedBy String?
  rejectedAt DateTime?
  rejectedBy String?
  rejectionReason String?
  completedAt DateTime?
  resetToken String?  @unique // Token generated after approval
  tokenExpiresAt DateTime?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, requestedAt])
  @@index([userId])
  @@index([email])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, expiresAt])
  @@index([userId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([endpoint])
}

// Government HR: Profile Change Requests
model ProfileChangeRequest {
  id            String   @id @default(cuid())
  staffId       String
  section       String   // 'personal' | 'bank' | 'tax' | 'certifications' | 'training'
  requestedChanges String // Description of requested changes
  currentData   Json?    // Current data snapshot
  status        String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'completed'
  reviewedBy    String?  // HR user who reviewed
  reviewedAt    DateTime?
  rejectionReason String?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  staff StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)

  @@index([staffId, status])
  @@index([status, createdAt])
}

// Government HR: Leave Attachments
model LeaveAttachment {
  id            String   @id @default(cuid())
  leaveRequestId String
  name          String
  fileUrl       String
  fileSize      Int
  mimeType      String
  attachmentType String   // 'medical' | 'training' | 'memo' | 'other'
  uploadedBy    String
  uploadedAt    DateTime @default(now())
  description   String?

  // Relations
  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  @@index([leaveRequestId])
}

// Government HR: Approval Delegation
model ApprovalDelegation {
  id            String   @id @default(cuid())
  delegatorId   String   // Staff ID of person delegating
  delegateeId   String   // Staff ID of person receiving delegation
  startDate     DateTime
  endDate       DateTime
  leaveTypes    String[] // Leave types this delegation applies to (empty = all)
  status        String   @default("active") // 'active' | 'expired' | 'revoked'
  revokedAt     DateTime?
  revokedBy     String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  delegator StaffMember @relation("Delegator", fields: [delegatorId], references: [staffId], onDelete: Cascade)
  delegatee StaffMember @relation("Delegatee", fields: [delegateeId], references: [staffId], onDelete: Cascade)

  @@index([delegatorId, status, endDate])
  @@index([delegateeId, status, endDate])
  @@index([startDate, endDate])
}

// ============================================
// GHANA GOVERNMENT COMPLIANCE MODELS
// ============================================

// Leave Policy Versioning (for governance and audit)
// Per requirement: Policies are immutable once applied, changes create new version
model LeavePolicyVersion {
  id              String   @id @default(cuid())
  policyId        String?  // Reference to current active policy (if any, nullable for new policies)
  leaveType       String   // 'Annual' | 'Sick' | 'Unpaid' | 'Special Service' | 'Training' | 'Study' | 'Maternity' | 'Paternity' | 'Compassionate'
  maxDays         Int
  accrualRate     Float
  accrualFrequency String  @default("monthly")
  carryoverAllowed Boolean  @default(false)
  maxCarryover    Int      @default(0)
  expiresAfterMonths Int?
  requiresApproval Boolean  @default(true)
  approvalLevels  Int      @default(1)
  active          Boolean  @default(true)
  
  // Versioning fields
  versionNumber   Int      // Sequential version number (1, 2, 3, ...)
  effectiveFrom   DateTime // When this version became effective
  effectiveTo     DateTime? // When this version was superseded (null = current)
  supersededBy    String?  // ID of version that superseded this
  changedBy       String   // User ID who created this version
  changeReason    String   // Mandatory justification for policy change
  approvedBy      String?  // HR Director who approved the change
  approvedAt      DateTime? // When HR Director approved
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([policyId, versionNumber])
  @@index([leaveType, effectiveFrom])
  @@index([effectiveFrom, effectiveTo])
}

// Data Access Log (Data Protection Act 843 compliance)
// Tracks ALL access to sensitive personal data
model DataAccessLog {
  id            String   @id @default(cuid())
  userId        String   // User who accessed the data
  userRole      String   // Role of user
  staffId       String?  // Staff member whose data was accessed
  dataType      String   // 'staff_profile' | 'leave_request' | 'medical_attachment' | 'dob' | 'salary' | 'performance_review'
  action        String   // 'view' | 'export' | 'download' | 'edit'
  ip            String?  // IP address
  userAgent     String?  // User agent
  timestamp     DateTime @default(now())
  metadata      Json?    // Additional context (field names accessed, etc.)
  
  @@index([userId, timestamp])
  @@index([staffId, timestamp])
  @@index([dataType, timestamp])
  @@index([timestamp])
}

// Privacy Acknowledgement (Data Protection Act 843)
// Tracks staff acknowledgement of privacy notice
model PrivacyAcknowledgement {
  id            String   @id @default(cuid())
  userId        String   @unique // User ID
  staffId       String?  // Staff ID (if linked)
  acknowledgedAt DateTime @default(now())
  ip            String?  // IP address when acknowledged
  userAgent     String?  // User agent
  version       String   @default("1.0") // Privacy notice version
  
  // Relations
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([acknowledgedAt])
}

// Leave Balance Override (Manual balance adjustments with approval)
// Per requirement: Manual edits require HR Director approval
model LeaveBalanceOverride {
  id            String   @id @default(cuid())
  staffId       String
  leaveType     String   // Type of leave being adjusted
  previousBalance Float  // Balance before override
  newBalance    Float    // Balance after override
  adjustment    Float    // Difference (positive = increase, negative = decrease)
  reason        String   // Mandatory reason for override
  supportingDocumentUrl String? // Optional supporting document
  requestedBy   String   // User ID who requested
  requestedAt   DateTime @default(now())
  status        String   @default("pending") // 'pending' | 'approved' | 'rejected'
  approvedBy    String?  // HR Director who approved/rejected
  approvedAt    DateTime?
  rejectionReason String? // If rejected, reason
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  staff         StaffMember @relation(fields: [staffId], references: [staffId], onDelete: Cascade)
  
  @@index([staffId, status])
  @@index([status, requestedAt])
  @@index([requestedBy, requestedAt])
}

// Password History (for password reuse prevention)
model PasswordHistory {
  id            String   @id @default(cuid())
  userId        String
  passwordHash  String   // Hashed password (for comparison)
  createdAt     DateTime @default(now())
  
  // Relations
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
}

// Add relations to existing models
// Update User model to include new relations